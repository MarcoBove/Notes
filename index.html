<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vecchie Glorie</title>
    <style>
        :root {
            --primary: #2563eb;
            --danger: #dc2626;
            --success: #10b981;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 15px;
            padding-bottom: 100px;
        }

        h1 { text-align: center; color: #333; font-size: 1.4rem; margin-bottom: 20px;}

        #notes-container {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        }

        .note-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }
        
        /* Evidenzia la Classifica Marcatori */
        .note-card.special-card {
            border: 2px solid var(--primary);
            background-color: #f0f7ff;
        }

        /* HEADER DELLA NOTA */
        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #f0f0f0;
        }

        .note-title {
            font-weight: bold;
            font-size: 1.1rem;
            width: 80%;
            padding: 5px;
            background: transparent;
        }
        
        input.note-title { border: none; outline: none; color: #333; }
        input.note-title:focus { background: #feffde; }

        .btn-delete-note {
            background: #fee2e2;
            border: none;
            color: var(--danger);
            border-radius: 6px;
            padding: 5px 10px;
            font-size: 1.2rem;
            cursor: pointer;
        }

        /* TABELLA E RIGHE */
        .note-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        .note-table th { font-size: 0.75rem; color: #666; text-align: left; padding: 0 5px; }
        .note-table td { vertical-align: middle; }

        /* Input nome */
        .input-name {
            width: 100%;
            padding: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #fafafa;
        }
        input.input-name:focus { background: #fff; border-color: var(--primary); outline: none; }
        
        /* Checkbox custom */
        .check-box {
            width: 35px; height: 35px; border-radius: 6px; border: 2px solid #e5e7eb;
            background-color: #fff; display: flex; align-items: center; justify-content: center;
            margin: 0 auto; font-size: 1.2rem; color: white; transition: all 0.1s;
        }
        .check-box.checked { background-color: var(--success); border-color: var(--success); }
        .check-box.next-box.checked { background-color: var(--primary); border-color: var(--primary); }
        .check-box.editable { cursor: pointer; }
        .check-box.readonly { opacity: 0.6; }

        /* CONTROLLI GOAL */
        .goal-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .btn-score {
            width: 30px; height: 30px;
            border-radius: 50%; border: none;
            color: white; font-weight: bold; font-size: 1.2rem;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .btn-minus { background-color: #ef4444; }
        .btn-plus { background-color: #3b82f6; }
        
        .input-score {
            width: 40px; text-align: center;
            font-size: 1.1rem; padding: 5px;
            border: 1px solid #ddd; border-radius: 5px;
        }

        /* Bottone elimina riga */
        .btn-del-row {
            background: none; border: none; color: #ccc; font-size: 1.2rem; cursor: pointer; padding: 0 5px;
        }
        .btn-del-row:hover { color: var(--danger); }

        /* Footer della card */
        .card-footer {
            margin-top: 10px; text-align: center; border-top: 1px dashed #ccc; padding-top: 10px;
        }
        .btn-add-row {
            background-color: #eff6ff; color: var(--primary); border: none;
            padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer;
        }

        /* FAB */
        .fab {
            position: fixed; bottom: 20px; right: 20px;
            background-color: var(--primary); color: white;
            width: 60px; height: 60px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
            cursor: pointer; border: none; z-index: 100;
            display: none; 
        }

        /* Login */
        #login-trigger {
            position: fixed; bottom: 10px; left: 10px;
            font-size: 0.8rem; color: #999; text-decoration: underline;
            cursor: pointer; z-index: 50;
        }
        #login-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 2000;
            justify-content: center; align-items: center;
        }
        .login-box {
            background: white; padding: 20px; border-radius: 10px;
            display: flex; flex-direction: column; gap: 10px; width: 80%; max-width: 300px;
        }
        .login-box input { padding: 10px; font-size: 1rem; border: 1px solid #ddd; border-radius: 5px; }
        .login-box button { padding: 10px; background: var(--primary); color: white; border: none; border-radius: 5px; }

    </style>
</head>
<body>

    <h1>Vecchie Glorie <span id="mode-label" style="font-size:0.8rem; font-weight:normal; color:#888"></span></h1>

    <div id="notes-container">
        <p style="text-align:center; color:#999; margin-top:50px;">Caricamento...</p>
    </div>

    <button id="fab-add" class="fab" onclick="createNewNote()">+</button>

    <div id="login-trigger" onclick="toggleLogin()">Admin Login</div>

    <div id="login-modal" onclick="if(event.target === this) toggleLogin()">
        <div class="login-box">
            <h3 style="margin:0; text-align:center;">Area Admin</h3>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button onclick="doLogin()">Entra</button>
            <button onclick="doLogout()" style="background:#666; margin-top:5px;">Esci</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, orderBy, query } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // CONFIGURAZIONE CORRETTA E PULITA
        const firebaseConfig = {
             apiKey: "AIzaSyCotP9ye0eFqYw0E3BUp4289rHqlruAs_Q",
             authDomain: "notes-7edc0.firebaseapp.com",
             projectId: "notes-7edc0",
             storageBucket: "notes-7edc0.firebasestorage.app",
             messagingSenderId: "197957947166",
             appId: "1:197957947166:web:aee3eb14defa277289030f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const notesRef = collection(db, "note_spesa");

        let currentUser = null;
        let lastSnapshot = null;

        // --- GESTIONE LOGIN ---
        window.toggleLogin = () => {
            const modal = document.getElementById('login-modal');
            modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
        };

        window.doLogin = async () => {
            try {
                await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value);
                window.toggleLogin();
            } catch(e) { alert("Errore: " + e.message); }
        };
        window.doLogout = async () => { await signOut(auth); window.toggleLogin(); };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            document.getElementById('fab-add').style.display = user ? 'flex' : 'none';
            document.getElementById('mode-label').innerText = user ? "(Modifica)" : "(Solo Lettura)";
            if(lastSnapshot) renderNotes(lastSnapshot);
        });

        // --- LOGICA DATABASE ---
        window.createNewNote = async () => {
            if(!currentUser) return;
            await addDoc(notesRef, {
                titolo: "",
                righe: [ { nome: "", pagato: false, prossima: false } ], 
                creato_il: serverTimestamp()
            });
        };

        window.deleteNote = async (id) => {
            if(!currentUser || !confirm("Eliminare questa nota?")) return;
            await deleteDoc(doc(db, "note_spesa", id));
        };

        window.addRow = async (id, currentRows, noteTitle) => {
            if(!currentUser) return;
            let newObj = {};
            if(noteTitle === "Classifica marcatori") {
                newObj = { nome: "", goal: 0 };
            } else {
                newObj = { nome: "", pagato: false, prossima: false };
            }
            const newRows = [...currentRows, newObj];
            await updateDoc(doc(db, "note_spesa", id), { righe: newRows });
        };

        window.deleteRow = async (id, rowIndex, currentRows) => {
            if(!currentUser) return;
            const newRows = currentRows.filter((_, index) => index !== rowIndex);
            await updateDoc(doc(db, "note_spesa", id), { righe: newRows });
        };

        window.updateRowData = async (noteId, rowIndex, field, value, allRows) => {
            if(!currentUser) return;
            const newRows = JSON.parse(JSON.stringify(allRows)); 
            newRows[rowIndex][field] = value;
            await updateDoc(doc(db, "note_spesa", noteId), { righe: newRows });
        };

        window.changeScore = async (noteId, rowIndex, delta, allRows) => {
            if(!currentUser) return;
            const newRows = JSON.parse(JSON.stringify(allRows));
            let currentScore = parseInt(newRows[rowIndex].goal) || 0;
            newRows[rowIndex].goal = currentScore + delta;
            await updateDoc(doc(db, "note_spesa", noteId), { righe: newRows });
        };

        window.updateTitle = async (noteId, value) => {
            if(!currentUser) return;
            await updateDoc(doc(db, "note_spesa", noteId), { titolo: value });
        };

        // --- RENDERING ---
        const q = query(notesRef, orderBy("creato_il", "desc"));

        onSnapshot(q, (snapshot) => {
            lastSnapshot = snapshot;
            
            // CORREZIONE IMPORTANTE: 
            // Se c'Ã¨ scritto "Caricamento...", forziamo il rendering anche se l'utente sta scrivendo.
            // Altrimenti rischia di bloccarsi al primo avvio.
            const container = document.getElementById("notes-container");
            const isLoading = container.innerText.includes("Caricamento");

            if (!isLoading && document.activeElement.tagName === "INPUT" && document.activeElement.type === "text") return;
            
            renderNotes(snapshot);
        });

        function renderNotes(snapshot) {
            const container = document.getElementById("notes-container");
            container.innerHTML = "";

            let docs = [];
            let classificaDoc = null;

            snapshot.forEach(doc => {
                const data = doc.data();
                if(data.titolo && data.titolo.trim() === "Classifica marcatori") {
                    classificaDoc = { id: doc.id, ...data };
                } else {
                    docs.push({ id: doc.id, ...data });
                }
            });

            const drawCard = (note, isClassifica) => {
                const isAdmin = !!currentUser;
                const rowsRaw = note.righe || [];
                
                // Mappiamo per ordinamento
                let displayRows = rowsRaw.map((r, i) => ({ ...r, originalIndex: i }));

                if(isClassifica) {
                    displayRows.sort((a, b) => (b.goal || 0) - (a.goal || 0));
                }

                // FIX: Sanificazione stringa per evitare errori se ci sono apostrofi nei nomi
                const rowsString = JSON.stringify(rowsRaw).replace(/"/g, '&quot;').replace(/'/g, "\\'");
                const noteTitleClean = (note.titolo || "").replace(/"/g, '&quot;');

                let theadHtml = "";
                if(isClassifica) {
                    theadHtml = `<tr>
                        <th style="width:60%">Giocatore</th>
                        <th style="width:40%; text-align:center">Goal</th>
                        ${isAdmin ? '<th></th>' : ''}
                    </tr>`;
                } else {
                    theadHtml = `<tr>
                        <th style="width:50%">Oggetto</th>
                        <th style="width:20%; text-align:center">Pagato</th>
                        <th style="width:20%; text-align:center">Prossima</th>
                        ${isAdmin ? '<th></th>' : ''}
                    </tr>`;
                }

                let rowsHtml = "";
                
                displayRows.forEach((riga) => {
                    const realIndex = riga.originalIndex; 
                    let colsHtml = "";
                    
                    if(isClassifica) {
                        colsHtml = `
                        <td>
                            ${isAdmin ? 
                                `<input type="text" class="input-name" value="${riga.nome || ''}" 
                                  onchange="updateRowData('${note.id}', ${realIndex}, 'nome', this.value, ${rowsString})">` 
                                : `<span style="padding-left:5px; font-weight:bold;">${riga.nome || '-'}</span>`
                            }
                        </td>
                        <td>
                            <div class="goal-wrapper">
                                ${isAdmin ? `<button class="btn-score btn-minus" onclick="changeScore('${note.id}', ${realIndex}, -1, ${rowsString})">-</button>` : ''}
                                
                                ${isAdmin ? 
                                    `<input type="number" class="input-score" value="${riga.goal || 0}" 
                                      onchange="updateRowData('${note.id}', ${realIndex}, 'goal', parseInt(this.value), ${rowsString})">`
                                    : `<span style="font-size:1.2rem; font-weight:bold; color:#2563eb">${riga.goal || 0}</span>`
                                }

                                ${isAdmin ? `<button class="btn-score btn-plus" onclick="changeScore('${note.id}', ${realIndex}, 1, ${rowsString})">+</button>` : ''}
                            </div>
                        </td>
                        `;
                    } else {
                        colsHtml = `
                        <td>
                            ${isAdmin ? 
                                `<input type="text" class="input-name" value="${riga.nome || ''}" 
                                  onchange="updateRowData('${note.id}', ${realIndex}, 'nome', this.value, ${rowsString})">` 
                                : `<span style="padding-left:5px;">${riga.nome || '-'}</span>`
                            }
                        </td>
                        <td align="center">
                            <div class="check-box ${riga.pagato ? 'checked' : ''} ${isAdmin?'editable':'readonly'}"
                                 onclick="${isAdmin ? `updateRowData('${note.id}', ${realIndex}, 'pagato', ${!riga.pagato}, ${rowsString})` : ''}">
                                ${riga.pagato ? 'âœ”' : ''}
                            </div>
                        </td>
                        <td align="center">
                            <div class="check-box next-box ${riga.prossima ? 'checked' : ''} ${isAdmin?'editable':'readonly'}"
                                 onclick="${isAdmin ? `updateRowData('${note.id}', ${realIndex}, 'prossima', ${!riga.prossima}, ${rowsString})` : ''}">
                                ${riga.prossima ? 'âœ”' : ''}
                            </div>
                        </td>
                        `;
                    }

                    rowsHtml += `
                    <tr>
                        ${colsHtml}
                        ${isAdmin ? `
                        <td style="width:10%" align="center">
                            <button class="btn-del-row" onclick="deleteRow('${note.id}', ${realIndex}, ${rowsString})">Ã—</button>
                        </td>` : ''}
                    </tr>`;
                });

                return `
                    <div class="note-card ${isClassifica ? 'special-card' : ''}">
                        <div class="note-header">
                            ${isAdmin ? 
                                `<input type="text" class="note-title" placeholder="Titolo..." value="${note.titolo || ''}" onchange="updateTitle('${note.id}', this.value)">` 
                                : `<span class="note-title">${note.titolo || 'Senza Titolo'}</span>`
                            }
                            ${isAdmin ? `<button class="btn-delete-note" onclick="deleteNote('${note.id}')">ðŸ—‘</button>` : ''}
                        </div>
                        <table class="note-table">
                            <thead>${theadHtml}</thead>
                            <tbody>${rowsHtml}</tbody>
                        </table>
                        ${isAdmin ? `
                        <div class="card-footer">
                            <button class="btn-add-row" onclick="addRow('${note.id}', ${rowsString}, '${noteTitleClean}')">+ Aggiungi Riga</button>
                        </div>` : ''}
                    </div>
                `;
            };

            if(classificaDoc) {
                container.insertAdjacentHTML('beforeend', drawCard(classificaDoc, true));
            }
            docs.forEach(doc => {
                container.insertAdjacentHTML('beforeend', drawCard(doc, false));
            });
            
            // Se non ci sono note, togliamo la scritta caricamento
            if(!classificaDoc && docs.length === 0) {
                 container.innerHTML = '<p style="text-align:center; color:#999; margin-top:50px;">Nessuna nota presente.</p>';
            }
        }
    </script>
</body>
</html>

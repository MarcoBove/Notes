<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vecchie Glorie</title>
    <style>
        :root {
            --primary: #2563eb;
            --danger: #dc2626;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 15px;
            padding-bottom: 100px; /* Spazio extra in fondo */
        }

        h1 { text-align: center; color: #333; font-size: 1.4rem; margin-bottom: 20px;}

        #notes-container {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        }

        .note-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }

        /* HEADER DELLA NOTA */
        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #f0f0f0;
        }

        .note-title {
            font-weight: bold;
            font-size: 1.1rem;
            width: 80%;
            padding: 5px;
            background: transparent;
        }
        
        input.note-title { border: none; outline: none; color: #333; }
        input.note-title:focus { background: #feffde; }

        .btn-delete-note {
            background: #fee2e2;
            border: none;
            color: var(--danger);
            border-radius: 6px;
            padding: 5px 10px;
            font-size: 1.2rem;
            cursor: pointer;
        }

        /* TABELLA E RIGHE */
        .note-table { width: 100%; border-collapse: separate; border-spacing: 0 5px; }
        .note-table th { font-size: 0.75rem; color: #666; text-align: left; padding: 0 5px; }
        .note-table td { vertical-align: middle; }

        /* Input nome prodotto */
        .input-name {
            width: 100%;
            padding: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            border: 1px solid #eee;
            border-radius: 6px;
            background: #fafafa;
        }
        input.input-name:focus { background: #fff; border-color: var(--primary); outline: none; }
        
        /* Checkbox custom */
        .check-box {
            width: 35px;
            height: 35px;
            border-radius: 6px;
            border: 2px solid #e5e7eb;
            background-color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            font-size: 1.2rem;
            color: white;
            transition: all 0.1s;
        }
        .check-box.checked { background-color: #10b981; border-color: #10b981; }
        .check-box.next-box.checked { background-color: var(--primary); border-color: var(--primary); }
        .check-box.editable { cursor: pointer; }
        .check-box.readonly { opacity: 0.6; }

        /* Bottone elimina riga */
        .btn-del-row {
            background: none; border: none; color: #ccc; font-size: 1.2rem; cursor: pointer; padding: 0 5px;
        }
        .btn-del-row:hover { color: var(--danger); }

        /* Footer della card (Aggiungi riga) */
        .card-footer {
            margin-top: 10px;
            text-align: center;
            border-top: 1px dashed #eee;
            padding-top: 10px;
        }
        .btn-add-row {
            background-color: #eff6ff;
            color: var(--primary);
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
        }

        /* Bottone Flottante Nuova Nota */
        .fab {
            position: fixed; bottom: 20px; right: 20px;
            background-color: var(--primary); color: white;
            width: 60px; height: 60px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
            cursor: pointer; border: none; z-index: 100;
            display: none; /* Nascosto se non admin */
        }

        /* Login System */
        #login-trigger {
            position: fixed; bottom: 10px; left: 10px;
            font-size: 0.8rem; color: #999; text-decoration: underline;
            cursor: pointer; z-index: 50;
        }
        #login-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 2000;
            justify-content: center; align-items: center;
        }
        .login-box {
            background: white; padding: 20px; border-radius: 10px;
            display: flex; flex-direction: column; gap: 10px; width: 80%; max-width: 300px;
        }
        .login-box input { padding: 10px; font-size: 1rem; border: 1px solid #ddd; border-radius: 5px; }
        .login-box button { padding: 10px; background: var(--primary); color: white; border: none; border-radius: 5px; font-size: 1rem; }

    </style>
</head>
<body>

    <h1> Vecchie Glorie <span id="mode-label" style="font-size:0.8rem; font-weight:normal; color:#888"></span></h1>

    <div id="notes-container">
        <p style="text-align:center; color:#999; margin-top:50px;">Caricamento...</p>
    </div>

    <button id="fab-add" class="fab" onclick="createNewNote()">+</button>

    <div id="login-trigger" onclick="toggleLogin()">Admin Login</div>

    <div id="login-modal" onclick="if(event.target === this) toggleLogin()">
        <div class="login-box">
            <h3 style="margin:0; text-align:center;">Area Admin</h3>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button onclick="doLogin()">Entra</button>
            <button onclick="doLogout()" style="background:#666; margin-top:5px;">Esci / Logout</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, orderBy, query } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // -----------------------------------------------------------
        // INCOLLA QUI LA TUA CONFIGURAZIONE FIREBASE
        // -----------------------------------------------------------
       const firebaseConfig = {
             apiKey: "AIzaSyCotP9ye0eFqYw0E3BUp4289rHqlruAs_Q",
             authDomain: "notes-7edc0.firebaseapp.com",
             projectId: "notes-7edc0",
             storageBucket: "notes-7edc0.firebasestorage.app",
             messagingSenderId: "197957947166",
             appId: "1:197957947166:web:aee3eb14defa277289030f"
      };        
        // -----------------------------------------------------------

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const notesRef = collection(db, "note_spesa");

        let currentUser = null;
        let activeElementId = null; // Per evitare refresh fastidiosi

        // --- GESTIONE LOGIN ---
        window.toggleLogin = () => {
            const modal = document.getElementById('login-modal');
            modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
        };

        window.doLogin = async () => {
            try {
                await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value);
                window.toggleLogin();
            } catch(e) { alert("Errore: " + e.message); }
        };
        window.doLogout = async () => { await signOut(auth); window.toggleLogin(); };

        // --- GESTIONE STATO UTENTE ---
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            document.getElementById('fab-add').style.display = user ? 'flex' : 'none';
            document.getElementById('mode-label').innerText = user ? "(Modifica)" : "(Solo Lettura)";
            // Ricarichiamo la vista al cambio login, ma senza query al DB (usa cache snapshot)
            if(lastSnapshot) renderNotes(lastSnapshot);
        });

        // --- LOGICA DATABASE ---
        
        // 1. Crea Nuova Nota (Con array di righe vuoto)
        window.createNewNote = async () => {
            if(!currentUser) return;
            await addDoc(notesRef, {
                titolo: "",
                righe: [ { nome: "", pagato: false, prossima: false } ], // Parte con 1 riga vuota
                creato_il: serverTimestamp()
            });
        };

        // 2. Elimina Intera Nota
        window.deleteNote = async (id) => {
            if(!currentUser || !confirm("Eliminare tutta la nota?")) return;
            await deleteDoc(doc(db, "note_spesa", id));
        };

        // 3. Aggiungi Riga alla Nota
        window.addRow = async (id, currentRows) => {
            if(!currentUser) return;
            const newRows = [...currentRows, { nome: "", pagato: false, prossima: false }];
            await updateDoc(doc(db, "note_spesa", id), { righe: newRows });
        };

        // 4. Elimina Singola Riga
        window.deleteRow = async (id, rowIndex, currentRows) => {
            if(!currentUser) return;
            const newRows = currentRows.filter((_, index) => index !== rowIndex);
            await updateDoc(doc(db, "note_spesa", id), { righe: newRows });
        };

        // 5. AGGIORNAMENTO DATI (Cuore del fix tastiera)
        // Usiamo "onchange" per i testi: salva solo quando esci dal campo.
        window.updateRowData = async (noteId, rowIndex, field, value, allRows) => {
            if(!currentUser) return;
            
            // Copia profonda dell'array per modificarlo
            const newRows = JSON.parse(JSON.stringify(allRows));
            newRows[rowIndex][field] = value;
            
            await updateDoc(doc(db, "note_spesa", noteId), { righe: newRows });
        };

        window.updateTitle = async (noteId, value) => {
            if(!currentUser) return;
            await updateDoc(doc(db, "note_spesa", noteId), { titolo: value });
        };


        // --- RENDERING ---
        let lastSnapshot = null;
        const q = query(notesRef, orderBy("creato_il", "desc"));

        onSnapshot(q, (snapshot) => {
            lastSnapshot = snapshot;
            
            // Se c'Ã¨ un elemento attivo (stai scrivendo), non ridisegnare tutto brutalmente
            // Ma per sicurezza con "onchange" il problema Ã¨ minimizzato.
            if(document.activeElement.tagName === "INPUT" && document.activeElement.type === "text") {
                // Stiamo scrivendo, aspettiamo il prossimo ciclo o il blur per aggiornare visualmente
                // Questo evita che la tastiera sparisca se qualcun altro aggiorna
                return; 
            }
            renderNotes(snapshot);
        });

        function renderNotes(snapshot) {
            const container = document.getElementById("notes-container");
            container.innerHTML = "";

            snapshot.forEach(docSnap => {
                const note = docSnap.data();
                const id = docSnap.id;
                const isAdmin = !!currentUser;
                const rows = note.righe || [];

                // Serializziamo le righe per passarle alle funzioni onclick (trucco per evitare problemi con array)
                const rowsString = JSON.stringify(rows).replace(/"/g, '&quot;');

                // Costruiamo le righe della tabella
                let rowsHtml = "";
                rows.forEach((riga, index) => {
                    rowsHtml += `
                    <tr>
                        <td style="width:50%">
                            ${isAdmin ? 
                                `<input type="text" class="input-name" value="${riga.nome}" 
                                  onchange="updateRowData('${id}', ${index}, 'nome', this.value, ${rowsString})">` 
                                : `<span style="padding-left:5px;">${riga.nome || '-'}</span>`
                            }
                        </td>
                        <td style="width:20%">
                            <div class="check-box ${riga.pagato ? 'checked' : ''} ${isAdmin?'editable':'readonly'}"
                                 onclick="${isAdmin ? `updateRowData('${id}', ${index}, 'pagato', ${!riga.pagato}, ${rowsString})` : ''}">
                                ${riga.pagato ? 'âœ”' : ''}
                            </div>
                        </td>
                        <td style="width:20%">
                            <div class="check-box next-box ${riga.prossima ? 'checked' : ''} ${isAdmin?'editable':'readonly'}"
                                 onclick="${isAdmin ? `updateRowData('${id}', ${index}, 'prossima', ${!riga.prossima}, ${rowsString})` : ''}">
                                ${riga.prossima ? 'âœ”' : ''}
                            </div>
                        </td>
                        ${isAdmin ? `
                        <td style="width:10%">
                            <button class="btn-del-row" onclick="deleteRow('${id}', ${index}, ${rowsString})">Ã—</button>
                        </td>` : ''}
                    </tr>`;
                });

                // HTML COMPLETO DELLA CARD
                const cardHtml = `
                    <div class="note-card">
                        <div class="note-header">
                            ${isAdmin ? 
                                `<input type="text" class="note-title" placeholder="Titolo..." value="${note.titolo}" onchange="updateTitle('${id}', this.value)">` 
                                : `<span class="note-title">${note.titolo || 'Senza Titolo'}</span>`
                            }
                            ${isAdmin ? `<button class="btn-delete-note" onclick="deleteNote('${id}')">ðŸ—‘</button>` : ''}
                        </div>

                        <table class="note-table">
                            <thead>
                                <tr>
                                    <th>Oggetto</th>
                                    <th style="text-align:center">Pagato</th>
                                    <th style="text-align:center">Prossima</th>
                                    ${isAdmin ? '<th></th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${rowsHtml}
                            </tbody>
                        </table>

                        ${isAdmin ? `
                        <div class="card-footer">
                            <button class="btn-add-row" onclick="addRow('${id}', ${rowsString})">+ Aggiungi Riga</button>
                        </div>` : ''}
                    </div>
                `;

                container.insertAdjacentHTML('beforeend', cardHtml);
            });
        }
    </script>
</body>
</html>
